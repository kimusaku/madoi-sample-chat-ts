(()=>{var e={236:e=>{self,e.exports=(()=>{"use strict";var e={d:(t,s)=>{for(var o in s)e.o(s,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:s[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function s(e={}){return e=>{}}e.r(t),e.d(t,{ShareClass:()=>s,Share:()=>n,GetState:()=>i,SetState:()=>a,EnterRoom:()=>c,LeaveRoom:()=>h,PeerJoin:()=>d,PeerLeave:()=>l,Madoi:()=>p});const o={type:"beforeExec",maxLog:0,allowedTo:["USER"]};function n(e=o){const t=e;return t.type||(t.type="beforeExec"),t.maxLog||(t.maxLog=0),(e,s,o)=>{const n={share:t};e[s].madoiMethodConfig_=n}}const r={maxInterval:5e3};function i(e=r){const t=e;return(e,s,o)=>{const n={getState:t};e[s].madoiMethodConfig_=n}}function a(e={}){const t=e;return(e,s,o)=>{const n={setState:t};e[s].madoiMethodConfig_=n}}function c(e={}){const t=e;return(e,s,o)=>{const n={enterRoom:t};e[s].madoiMethodConfig_=n}}function h(e={}){const t=e;return(e,s,o)=>{const n={leaveRoom:t};e[s].madoiMethodConfig_=n}}function d(e={}){const t=e;return(e,s,o)=>{const n={peerJoin:t};e[s].madoiMethodConfig_=n}}function l(e={}){const t=e;return(e,s,o)=>{const n={peerLeave:t};e[s].madoiMethodConfig_=n}}class p{constructor(e,t="",s={}){this.connecting=!1,this.sharedFunctions=[],this.sharedObjects=[],this.getStateMethods=new Map,this.setStateMethods=new Map,this.enterRoomMethods=new Map,this.leaveRoomMethods=new Map,this.peerJoinMethods=new Map,this.peerLeaveMethods=new Map,this.promises={},this.changedObjects=new Map,this.handlers={},this.selfPeerId=null,this.currentSenderPeerId=null,this.interimQueue=new Array,this.sendMessage({type:"SessionInfo",body:s});let o=null;if(e.match(/^wss?:\/\//))o=e+`?key=${t}`;else{const s=document.querySelector("script[src$='madoi.js']").src.split("/",5);o=`${("http:"==s[0]?"ws:":"wss:")+"//"+s[2]+"/"+s[3]}/${e}?key=${t}`}this.ws=new WebSocket(o),this.ws.onopen=e=>this.handleOnOpen(e),this.ws.onclose=e=>this.handleOnClose(e),this.ws.onerror=e=>this.handleOnError(e),this.ws.onmessage=e=>this.handleOnMessage(e),setInterval((()=>{this.saveStates()}),1e3)}getCurrentSenderPeerId(){return this.currentSenderPeerId}isSelfCall(){return this.currentSenderPeerId==this.selfPeerId}close(){var e;null===(e=this.ws)||void 0===e||e.close()}handleOnOpen(e){var t;this.connecting=!0;for(let e of this.interimQueue)null===(t=this.ws)||void 0===t||t.send(JSON.stringify(e));this.interimQueue=[],this.onOpen(e)}handleOnClose(e){console.debug(`websocket closed because: ${e.reason}.`),this.connecting=!1,this.onClose(e),this.ws=null}handleOnError(e){this.onError(e)}handleOnMessage(e){var t=JSON.parse(e.data);this.currentSenderPeerId=t.sender,this.data(t)}data(e){if("EnterRoom"==e.type){for(const[t,s]of this.enterRoomMethods)s(e.peerId,e.peers);const t=e;if(this.selfPeerId=t.peerId,this.onEnterRoom(e.peerId,e.peers),e.histories)for(const t of e.histories)this.data(t)}else if("LeaveRoom"==e.type){for(const[t,s]of this.leaveRoomMethods)s(e.peerId);this.onLeaveRoom()}else if("PeerJoin"==e.type){for(const[t,s]of this.peerJoinMethods)s(e.peerId);this.onPeerJoin(e.peerId)}else if("PeerLeave"==e.type){for(const[t,s]of this.peerLeaveMethods)s(e.peerId);this.onPeerLeave(e.peerId)}else if("Invocation"==e.type){const t=this.sharedFunctions[e.funcId];if(t){const s=this.applyInvocation(t,e.args);s instanceof Promise&&s.then((()=>{this.promises[e.funcId].resolve.apply(null,arguments)})).catch((()=>{this.promises[e.funcId].reject.apply(null,arguments)}))}else this.onElse(e)}else if("ObjectState"==e.type){const t=this.setStateMethods.get(e.objId);t&&t(e.state)}else{const t=e;this.handlers[t.type]?this.handlers[t.type](t.body):this.onElse(t)}}onOpen(e){}onClose(e){}onError(e){}onElse(e){}onEnterRoom(e,t){}onLeaveRoom(){}onPeerJoin(e){}onPeerLeave(e){}send(e,t,s){this.ws&&this.sendMessage({type:e,headers:s,body:t})}broadcast(e,t,s){this.sendMessage({type:e,castType:"BROADCAST",body:t})}othercast(e,t,s){this.sendMessage({type:e,castType:"OTHERCAST",body:t})}setHandler(e,t){this.handlers[e]=t}clearHandler(e){delete this.handlers}sendMessage(e){var t;this.connecting?null===(t=this.ws)||void 0===t||t.send(JSON.stringify(e)):this.interimQueue.push(e)}register(e,t=[]){if(!this.ws)return;if(e.madoiObjectId_)return void console.warn("Ignore object registration because it's already registered.");const s=e.constructor.name,n=this.sharedObjects.length;this.sharedObjects.push(e),e.madoiObjectId_=n;const i=new Array,a=new Array,c=new Map;Object.getOwnPropertyNames(e.__proto__).forEach((t=>{const o=e[t];if("function"!=typeof o)return;if(!o.madoiMethodConfig_)return;const n=o.madoiMethodConfig_,r=i.length;c.set(t,r),i.push(o),a.push({name:t,config:n}),console.debug(`add config ${s}.${t}=${JSON.stringify(n)} from decorator`)}));for(const e of t){const t=e.method,n=t.name;let h;if(e.share)e.share.type||(e.share.type=o.type),e.share.maxLog||(e.share.maxLog=o.maxLog),h={share:e.share};else if(e.getState)e.getState.maxInterval||(e.getState.maxInterval=r.maxInterval),h={getState:e.getState};else if(e.setState)h={setState:e.setState};else if(e.enterRoom)h={enterRoom:e.enterRoom};else if(e.leaveRoom)h={leaveRoom:e.leaveRoom};else if(e.peerJoin)h={peerJoin:e.peerJoin};else{if(!e.peerLeave)continue;h={peerLeave:e.peerLeave}}const d=c.get(n);if(void 0===d){const o=i.length;c.set(n,o),i.push(t),a.push({name:e.method.name,config:h}),console.debug(`add config ${s}=${JSON.stringify(e)} from argument`)}else a[d].config=h,console.debug(`replace config ${s}=${JSON.stringify(e)} from argument`)}for(let t=0;t<i.length;t++){const s=i[t],o=a[t];if(o.config.share){const[t,r]=this.addSharedFunction(s.bind(e),o.config.share,n);o.funcId=t;const i=this;e[s.name]=function(){const e=i.changedObjects.get(n);return e?i.changedObjects.set(n,e+1):i.changedObjects.set(n,1),r.apply(null,arguments)}}else o.config.getState?this.getStateMethods.set(n,{method:s.bind(e),config:o.config.getState,lastGet:0}):o.config.setState?this.setStateMethods.set(n,s.bind(e)):o.config.enterRoom?this.enterRoomMethods.set(n,s.bind(e)):o.config.leaveRoom?this.leaveRoomMethods.set(n,s.bind(e)):o.config.peerJoin?this.peerJoinMethods.set(n,s.bind(e)):o.config.peerLeave&&this.peerLeaveMethods.set(n,s.bind(e))}const h={type:"ObjectInfo",objId:n,className:s,methods:a};this.sendMessage(h)}registerShareFunction(e,t=o){const s=e.name,[n,r]=this.addSharedFunction(e,t),i={type:"FunctionInfo",funcId:n,name:s,config:t};return this.sendMessage(i),function(){return r.apply(null,arguments)}}addSharedFunction(e,t,s){const o=this.sharedFunctions.length;this.sharedFunctions.push(e),this.promises[o]={},this.promises[o].promise=new Promise(((e,t)=>{this.promises[o].resolve=e,this.promises[o].reject=t}));const n=this;return[o,function(){if(null!=n.ws){let r=null,i="BROADCAST";"afterExec"==t.type&&(r=e.apply(null,arguments),i="OTHERCAST");const a={type:"Invocation",sender:n.selfPeerId,castType:i,objId:s,funcId:o,funcName:e.name,args:Array.from(arguments)};return n.ws.send(JSON.stringify(a)),null!=r?r:n.promises[o].promise}if(e)return e.apply(null,arguments)}]}saveStates(){if(this.ws&&this.connecting)for(let[e,t]of this.changedObjects){if(0==t)continue;const s=this.getStateMethods.get(e);if(!s)continue;const o=performance.now();if(s.config.maxUpdates&&s.config.maxUpdates<=t||s.config.maxInterval&&s.config.maxInterval<=o-s.lastGet){const t={type:"ObjectState",objId:e,state:s.method()};this.ws.send(JSON.stringify(t)),s.lastGet=o,this.changedObjects.set(e,0),console.log(`state saved: ${e}`)}}}applyInvocation(e,t){return e.apply(null,t)}}return t})()}},t={};function s(o){var n=t[o];if(void 0!==n)return n.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=s(236),t=function(e,t,s,o){var n,r=arguments.length,i=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,s):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(r<3?n(i):r>3?n(t,s,i):n(t,s))||i);return r>3&&i&&Object.defineProperty(t,s,i),i};window.addEventListener("load",(()=>{const t=new o("#chatForm","#name","#message","#chatLog");new e.Madoi("wss://fungo.kcg.edu/madoi-20211030/rooms/chat-o3i4falskdjj").register(t)}));class o{constructor(e,t,s,o){this.logs=[],this.chatForm=document.querySelector(e),this.nameInput=document.querySelector(t),this.messageInput=document.querySelector(s),this.logDiv=document.querySelector(o),this.chatForm.addEventListener("submit",(e=>{e.preventDefault();const t=this.nameInput.value.trim(),s=this.messageInput.value.trim();if(0==s.length)return!1;this.messageInput.value="",this.addMessage(t,s)}))}addMessage(e,t){const s=e+": "+t;this.appendLog(s),this.logDiv.scrollTop=this.logDiv.scrollHeight,this.logs.push(s),this.logs.length>100&&this.logs.splice(0,this.logs.length-100)}appendLog(e){const t=document.createElement("span"),s=document.createElement("br");t.append(e),this.logDiv.append(t),this.logDiv.append(s)}getState(){return JSON.stringify(this.logs)}setState(e){this.logs=JSON.parse(e),this.logDiv.innerHTML="";for(let e of this.logs)this.appendLog(e);this.logDiv.scrollTop=this.logDiv.scrollHeight}}t([(0,e.Share)()],o.prototype,"addMessage",null),t([(0,e.GetState)()],o.prototype,"getState",null),t([(0,e.SetState)()],o.prototype,"setState",null)})()})();